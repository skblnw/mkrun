#!/bin/csh
#

# Generated by CHARMM-GUI (http://www.charmm-gui.org)

# This folder contains AMBER formatted CHARMM36 force fields, a pre-optimized PDB structure, and AMBER inputs.
# All input files were optimized for AMBER16 or above, so lower version of AMBER can cause some errors.
# CHARMM36 FF to AMBER format conversion was done by ParmEd, written by Jason Swails and available at
# http://github.com/ParmEd/ParmEd. In this script, the parallel (MPI) version is commented out. Use this line
# for parallel execution instead (adjust for your MPI and the number of CPUs you want to use). Alternatively,
# if you have access to pmemd.cuda or are willing to use sander, you can replace "pmemd" with pmemd.cuda or sander and
# "pmemd.MPI" with pmemd.cuda.MPI or sander.MPI
#
# There is a known issue in current CHARMM-GUI AMBER inputs with "sander".
# If you are willing to use "sander" for your simulation, please remove "&end" line in all minimization / equilibration
# inputs.

set amber = pmemd
# set amber = "mpirun -np 4 pmemd.MPI"

# Minimization
# In the case that there is a problem during minimization using a pmemd.cuda, please try to use pmemd only for
# the minimization step.

# step6.0
set init = step5_input
set istep = step6.0_minimization

if (-e dihe.restraint) sed -e "s/FC/250.0/g" dihe.restraint > ${istep}.rest
pmemd -O -i ${istep}.mdin -p ${init}.parm7 -c ${init}.rst7 -o ${istep}.mdout -r ${istep}.rst7 -inf ${istep}.mdinfo -ref ${init}.rst7


# Equilibration
# step6.[1-6]
set cnt = 1
set cntmax = 6
set fc = {'250.0','100.0','50.0','50.0','25.0'}

while ( ${cnt} <= ${cntmax} )
    @ pcnt = ${cnt} - 1
    if ( ${cnt} == 1 ) then
            set pstep = step6.${pcnt}_minimization
            set istep = step6.${cnt}_equilibration
    else
            set pstep = step6.${pcnt}_equilibration
            set istep = step6.${cnt}_equilibration
    endif
    if (-e dihe.restraint && ${cnt} < ${cntmax}) then
        sed -e "s/FC/${fc[${cnt}]}/g" dihe.restraint > ${istep}.rest
    endif
    ${amber} -O -i ${istep}.mdin -p ${init}.parm7 -c ${pstep}.rst7 -o ${istep}.mdout -r ${istep}.rst7 -inf ${istep}.mdinfo -ref ${init}.rst7 -x ${istep}.nc
    @ cnt += 1
end


# Production
# step7
set cnt    = 1
set cntmax = 10
set input  = step7_production

while ( ${cnt} <= ${cntmax} )
    @ pcnt = ${cnt} - 1
    if ( ${cnt} == 1 ) then
            set pstep = step6.6_equilibration
            set istep = step7_${cnt}
    else
            set pstep = step7_${pcnt}
            set istep = step7_${cnt}
    endif
    ${amber} -O -i ${input}.mdin -p ${init}.parm7 -c ${pstep}.rst7 -o ${istep}.mdout -r ${istep}.rst7 -inf ${istep}.mdinfo -x ${istep}.nc
    @ cnt += 1
end

