#PBS -N win24
#PBS -q amd
#PBS -l nodes=1:ppn=24:gpus=8
#PBS -l walltime=999:00:00
#PBS -S /bin/bash
#PBS -j oe

date
echo "CUDA_VISIBLE_DEVICES: $CUDA_VISIBLE_DEVICES"
NP=`cat $PBS_NODEFILE | wc -l`
echo "NP: $NP"
cd $PBS_O_WORKDIR
echo $PBS_O_WORKDIR
source /public/software/apps/gromacs/2022.2-openmpi/bin/GMXRC.bash
export LD_LIBRARY_PATH=/public/software/lib/:$LD_LIBRARY_PATH
source /public/software/compiler/intel/intel-compiler-2017.5.239/bin/compilervars.sh intel64
source /public/software/profile.d/mpi_openmpi-intel-2.1.2.sh

NWINDOWS=24
start=0
end=$(($NWINDOWS - 1))

for ii in $(seq $start $end); do
  gmx_mpi grompp -f dir$ii/em.mdp -c pdb2gmx/ionized.pdb -r pdb2gmx/ionized.pdb -p pdb2gmx/topol.top -o dir$ii/em.tpr -maxwarn 3
done
mpirun -np $NP -hostfile $PBS_NODEFILE --mca orte_rsh_agent ssh --mca btl self,openib,sm gmx_mpi mdrun -v -deffnm em -multidir dir{0..23} 

for ii in $(seq $start $end); do
  gmx_mpi grompp -f dir$ii/nvt.mdp -c dir$ii/em.gro -r dir$ii/em.gro -p pdb2gmx/topol.top -o dir$ii/nvt.tpr -maxwarn 2
done
mpirun -np $NP -hostfile $PBS_NODEFILE --mca orte_rsh_agent ssh --mca btl self,openib,sm gmx_mpi mdrun -v -deffnm nvt -multidir dir{0..23} -nb gpu -bonded gpu

for ii in $(seq $start $end); do
  gmx_mpi grompp -f dir$ii/md.mdp -c dir$ii/nvt.gro -p pdb2gmx/topol.top -o dir$ii/md.tpr -maxwarn 1
done
mpirun -np $NP -hostfile $PBS_NODEFILE --mca orte_rsh_agent ssh --mca btl self,openib,sm gmx_mpi mdrun -v -deffnm md -multidir dir{0..23} -replex 1000 -nb gpu -bonded gpu

